// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(uuid())
  username    String   @unique
  password    String?
  name        String
  role        String
  permissions String   // Stored as JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  accountGroupId String?
  accountGroup   AccountGroup? @relation(fields: [accountGroupId], references: [id])
}

model AccountGroup {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  settlementByCompleted Boolean @default(true)
  highTicketRate Float @default(0) // Percentage for high ticket commission
  users       User[]
  rules       CommissionRule[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChannelConfig {
  id          String   @id @default(uuid())
  name        String   @unique
  isEnabled   Boolean  @default(true)
  settlementByCompleted Boolean @default(true)
  rules       CommissionRule[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orders      Order[]
  promoters   Promoter[]
}

model AppConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CommissionRule {
  id              String   @id @default(uuid())
  type            String   @default("QUANTITY") // QUANTITY, GMV
  minCount        Int
  maxCount        Int?     // null represents infinity
  percentage      Float
  target          String   @default("USER") // USER, PROMOTER
  
  accountGroupId  String?
  accountGroup    AccountGroup? @relation(fields: [accountGroupId], references: [id], onDelete: Cascade)
  
  channelConfigId String?
  channelConfig   ChannelConfig? @relation(fields: [channelConfigId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Promoter {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  channel   String?
  
  channelConfigId String?
  channelConfig   ChannelConfig? @relation(fields: [channelConfigId], references: [id])

  creatorId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]
}

model OnlineOrder {
  id                    String   @id @default(uuid())
  orderNo               String   @unique
  platform              String
  status                String
  merchantName          String?
  productName           String?
  variantName           String?
  totalAmount           Float?
  rentStartDate         DateTime?
  returnDeadline        DateTime?
  logisticsCompany      String?
  trackingNumber        String?
  latestLogisticsInfo   String?
  returnLogisticsCompany String?
  returnTrackingNumber  String?
  returnLatestLogisticsInfo String?
  promotionChannel      String?
  
  customerName          String?
  recipientPhone        String?
  address               String?
  
  duration              Int?
  rentPrice             Float?
  deposit               Float?
  insurancePrice        Float?

  itemTitle             String?
  itemSku               String?
  productId             String?
  customerXianyuId      String?
  sourceContact         String?
  source                String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}


model BackupLog {
  id        String   @id @default(uuid())
  type      String
  status    String
  operator  String
  details   String
  timestamp DateTime @default(now())
}

model Product {
  id            String   @id @default(uuid())
  name          String
  variants      String   // Stored as JSON string
  matchKeywords String?  // Stored as JSON string array, used for auto-mapping from external orders
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]
}

model Order {
  id          String   @id @default(uuid())
  orderNo     String   @unique
  source      String
  platform    String?
  promotionChannel String?
  status      String
  
  customerXianyuId String
  sourceContact    String
  miniProgramOrderNo String?
  xianyuOrderNo    String?
  
  productName String
  variantName String
  sn          String?

  itemTitle   String?
  itemSku     String?
  merchantName String?
  
  duration        Int
  rentPrice       Float
  deposit         Float
  insurancePrice  Float
  overdueFee      Float?
  totalAmount     Float
  
  standardPrice   Float @default(0) // Standard price snapshot from product config
  
  address           String
  recipientName     String?
  recipientPhone    String?
  trackingNumber    String?
  logisticsCompany  String?
  latestLogisticsInfo String?
  
  returnTrackingNumber    String?
  returnLogisticsCompany  String?
  returnLatestLogisticsInfo String?
  
  rentStartDate   DateTime?
  deliveryTime    DateTime?
  actualDeliveryTime DateTime?
  completedAt    DateTime?
  returnDeadline  DateTime?
  
  remark          String?
  screenshot      String?
  
  promoterId      String?
  promoter        Promoter? @relation(fields: [promoterId], references: [id])
  
  productId       String?
  product         Product?  @relation(fields: [productId], references: [id])
  
  channelId       String?
  channel         ChannelConfig? @relation(fields: [channelId], references: [id])

  creatorId       String
  creatorName     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  extensions      OrderExtension[]
  logs            OrderLog[]
}

model OrderExtension {
  id        String   @id @default(uuid())
  days      Int
  price     Float
  createdAt DateTime @default(now())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model OrderLog {
  id        String   @id @default(uuid())
  action    String
  desc      String?
  operator  String
  createdAt DateTime @default(now())
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}
